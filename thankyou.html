<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Merci pour votre achat !</title>

  <!-- Script DataFast -->
  <script
    defer
    data-website-id="683f535ef1a0753281970df8"
    data-domain="toolmonsters-lab.com"
    src="https://datafa.st/js/script.js">
  </script>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 4rem;
      background: #fff;
    }
  </style>
</head>
<body>
  <h1>‚úÖ Merci pour votre achat !</h1>
  <p>Votre commande a bien √©t√© enregistr√©e.</p>

  <script>
    // R√©cup√©ration des param√®tres d'URL
    const params = new URLSearchParams(window.location.search);
    const visitorId = params.get("datafast_visitor_id");
    const sessionId = params.get("datafast_session_id");
    const amount = params.get("amount"); // √Ä ajouter dans l'URL de redirection
    const email = params.get("email");
    const stripePaymentId = params.get("stripe_payment_id");

    // 1. Client-side tracking (√©v√©nement payment)
    // Attends que le script DataFast soit charg√©
    const waitForDatafast = setInterval(() => {
      if (typeof window.datafast === "function") {
        clearInterval(waitForDatafast);
        // Reconnecte la session si besoin
        if (visitorId && sessionId) {
          window.datafast("identify", {
            visitor_id: visitorId,
            session_id: sessionId
          });
        }
        // Envoie l'√©v√©nement payment
        window.datafast("payment", {
          email: email,
          amount: amount,
          stripe_payment_id: stripePaymentId
        });
        console.log("üéØ Paiement track√© c√¥t√© client");
      }
    }, 300);

    // 2. API DataFast (optionnel, si tu veux doubler le tracking)
    if (visitorId && sessionId) {
      fetch('https://datafa.st/api/v1/goals', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer df_941b4888e9dc3b611ac393980393954b54601bbb7f8f4aa7',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: "conversion",
          goal_name: "purchase",
          value: amount || 1.00,
          datafast_visitor_id: visitorId,
          datafast_session_id: sessionId,
          metadata: {
            source: "toolmonsters-lab.com",
            stripe_payment_id: stripePaymentId,
            email: email
          }
        })
      })
      .then(response => {
        if (!response.ok) throw new Error('Erreur DataFast');
        console.log('üéØ Conversion track√©e via API');
      })
      .catch(error => console.error('‚ùå Erreur tracking API:', error));
    }
  </script>
</body>
</html>
